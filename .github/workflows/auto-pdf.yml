name: ðŸ“„ Auto-Generate PDFs from Guides

on:
  push:
    paths:
      - 'guides/**.md'   # triggers whenever any guide markdown is added or changed
  workflow_dispatch:      # also runnable manually from GitHub Actions tab

jobs:
  build-pdfs:
    runs-on: ubuntu-latest
    permissions:
      contents: write     # needed to commit PDFs back to repo

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Pandoc + PDF engine
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y pandoc texlive-latex-base texlive-fonts-recommended texlive-latex-extra

      - name: Find changed/new guide markdown files
        id: find-guides
        run: |
          # On push: get files changed in this commit
          # On manual run: process ALL guides
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "Manual run â€” processing all guides"
            GUIDES=$(find guides/ -name "*.md" | tr '\n' ' ')
          else
            GUIDES=$(git diff --name-only HEAD~1 HEAD -- 'guides/*.md' | tr '\n' ' ')
            if [ -z "$GUIDES" ]; then
              echo "No guide .md files changed in this commit"
              exit 0
            fi
          fi
          echo "GUIDES=$GUIDES" >> $GITHUB_ENV
          echo "Guides to process: $GUIDES"

      - name: Generate PDFs
        run: |
          mkdir -p pdfs
          
          for GUIDE in $GUIDES; do
            if [ ! -f "$GUIDE" ]; then
              echo "Skipping $GUIDE â€” file not found"
              continue
            fi
            
            # Get filename without path and extension
            BASENAME=$(basename "$GUIDE" .md)
            OUTPUT="pdfs/${BASENAME}.pdf"
            
            echo "Converting $GUIDE â†’ $OUTPUT"
            
            pandoc "$GUIDE" \
              --output="$OUTPUT" \
              --pdf-engine=pdflatex \
              --variable=geometry:margin=1in \
              --variable=fontsize:12pt \
              --variable=linestretch:1.3 \
              --variable=colorlinks:true \
              --variable=linkcolor:teal \
              --toc \
              --toc-depth=2 \
              --highlight-style=tango \
              --metadata title="SolarPunk Remedies" \
              --metadata author="SolarPunk Mycelium" \
              --metadata date="$(date +%Y-%m-%d)" \
              2>&1 && echo "âœ… Created: $OUTPUT" || echo "âŒ Failed: $GUIDE"
          done

      - name: List generated PDFs
        run: |
          echo "=== Generated PDFs ==="
          ls -lh pdfs/ 2>/dev/null || echo "No PDFs in /pdfs"

      - name: Commit PDFs back to repo
        run: |
          git config user.name "SolarPunk Mycelium"
          git config user.email "solarpunk.mycelium@gmail.com"
          
          git add pdfs/
          
          # Only commit if there are actual changes
          if git diff --staged --quiet; then
            echo "No new PDFs to commit"
          else
            CHANGED=$(git diff --staged --name-only | tr '\n' ', ')
            git commit -m "ðŸ“„ Auto-generated PDFs: ${CHANGED}"
            git push
            echo "âœ… PDFs committed and pushed"
          fi

      - name: Summary
        run: |
          echo "### PDF Generation Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Generated PDFs:" >> $GITHUB_STEP_SUMMARY
          for PDF in pdfs/*.pdf; do
            if [ -f "$PDF" ]; then
              SIZE=$(du -h "$PDF" | cut -f1)
              echo "- \`$(basename $PDF)\` ($SIZE)" >> $GITHUB_STEP_SUMMARY
            fi
          done
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Next step: Upload to IPFS via web3.storage for permanent public access" >> $GITHUB_STEP_SUMMARY
